<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Teste de Procedimentos - SIGTAP</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f8fafc;
        }
        .container { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            border-radius: 6px; 
            margin: 10px 0; 
        }
        .success { background-color: #dcfce7; color: #166534; border: 1px solid #22c55e; }
        .error { background-color: #fef2f2; color: #dc2626; border: 1px solid #ef4444; }
        .warning { background-color: #fefce8; color: #ca8a04; border: 1px solid #eab308; }
        .info { background-color: #eff6ff; color: #2563eb; border: 1px solid #3b82f6; }
        button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        pre { 
            background: #f1f5f9; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto; 
            border: 1px solid #e2e8f0;
        }
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin: 20px 0;
        }
        h1 { color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; }
        h2 { color: #1f2937; }
        .test-result { 
            border: 1px solid #e5e7eb; 
            border-radius: 6px; 
            padding: 15px; 
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste de Procedimentos - SIGTAP Sync</h1>
        
        <div class="status info">
            <strong>üìã Objetivo:</strong> Testar a corre√ß√£o da busca de procedimentos na tabela <code>procedure_records</code>
        </div>

        <div class="grid">
            <div>
                <h2>üéõÔ∏è Controles de Teste</h2>
                <button onclick="testConnection()">üîó Testar Conex√£o Supabase</button>
                <button onclick="testProcedureRecordsTable()">üìä Verificar Tabela procedure_records</button>
                <button onclick="testSimpleQuery()">üîç Teste Query Simples</button>
                <button onclick="testComplexQuery()">üéØ Teste Query Complexa</button>
                <button onclick="testSpecificAIH()">üìã Testar AIH Espec√≠fica</button>
                <button onclick="createTestData()">üß™ Criar Dados de Teste</button>
                <button onclick="clearResults()">üßπ Limpar Resultados</button>
            </div>
            
            <div>
                <h2>üìä Status Atual</h2>
                <div id="status">
                    <div class="status warning">‚è≥ Aguardando teste...</div>
                </div>
            </div>
        </div>

        <div class="test-result">
            <h2>üìã Resultados dos Testes</h2>
            <div id="results"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        // ‚ö†Ô∏è CONFIGURA√á√ÉO - Substitua pelas suas credenciais
        const SUPABASE_URL = 'https://fvtfxunakabdrlkocdme.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2dGZ4dW5ha2FiZHJsa29jZG1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQxOTQxNTUsImV4cCI6MjA0OTc3MDE1NX0.F8Hfnk7k9ZW7eVH1e5OJE4MCZQ1OTKtc7f3ckqJ3xQs';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const TARGET_HOSPITAL_ID = 'a8978eaa-b90e-4dc8-8fd5-0af984374d34';
        const TARGET_AIH_ID = 'b9fc1770-aa93-4430-a34c-d2f6b39e0a78';

        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            
            results.innerHTML += `
                <div class="status ${type}">
                    <strong>[${timestamp}] ${title}</strong><br>
                    <pre>${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}</pre>
                </div>
            `;
            results.scrollTop = results.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            document.getElementById('status').innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // üîó Teste de Conex√£o
        window.testConnection = async () => {
            updateStatus('üîÑ Testando conex√£o...', 'info');
            try {
                const { data, error } = await supabase.from('hospitals').select('count').limit(1);
                if (error) throw error;
                
                addResult('‚úÖ Conex√£o Supabase', 'Conex√£o estabelecida com sucesso!', 'success');
                updateStatus('‚úÖ Conectado com sucesso', 'success');
            } catch (error) {
                addResult('‚ùå Erro de Conex√£o', error.message, 'error');
                updateStatus('‚ùå Falha na conex√£o', 'error');
            }
        };

        // üìä Verificar Tabela
        window.testProcedureRecordsTable = async () => {
            updateStatus('üîÑ Verificando tabela procedure_records...', 'info');
            try {
                const { data, error, count } = await supabase
                    .from('procedure_records')
                    .select('*', { count: 'exact', head: true });
                
                if (error) throw error;
                
                addResult('üìä Tabela procedure_records', `Total de registros: ${count || 0}`, count > 0 ? 'success' : 'warning');
                updateStatus(`üìä Tabela encontrada (${count || 0} registros)`, count > 0 ? 'success' : 'warning');
            } catch (error) {
                addResult('‚ùå Erro na Tabela', error.message, 'error');
                updateStatus('‚ùå Tabela n√£o acess√≠vel', 'error');
            }
        };

        // üîç Query Simples
        window.testSimpleQuery = async () => {
            updateStatus('üîÑ Executando query simples...', 'info');
            try {
                const { data, error } = await supabase
                    .from('procedure_records')
                    .select('*')
                    .eq('aih_id', TARGET_AIH_ID)
                    .limit(5);
                
                if (error) throw error;
                
                addResult('üîç Query Simples', `Encontrados ${data?.length || 0} procedimentos para AIH ${TARGET_AIH_ID}`, data?.length > 0 ? 'success' : 'warning');
                if (data?.length > 0) {
                    addResult('üìã Dados Encontrados', data, 'info');
                }
                updateStatus('‚úÖ Query simples executada', 'success');
            } catch (error) {
                addResult('‚ùå Erro Query Simples', error.message, 'error');
                updateStatus('‚ùå Query simples falhou', 'error');
            }
        };

        // üéØ Query Complexa
        window.testComplexQuery = async () => {
            updateStatus('üîÑ Executando query complexa...', 'info');
            try {
                const { data, error } = await supabase
                    .from('procedure_records')
                    .select(`
                        *,
                        sigtap_procedures(
                            code,
                            description,
                            value_hosp_total,
                            complexity
                        )
                    `)
                    .eq('aih_id', TARGET_AIH_ID);
                
                if (error) throw error;
                
                addResult('üéØ Query Complexa', `Encontrados ${data?.length || 0} procedimentos com SIGTAP`, data?.length > 0 ? 'success' : 'warning');
                if (data?.length > 0) {
                    addResult('üéØ Dados com SIGTAP', data, 'info');
                }
                updateStatus('‚úÖ Query complexa executada', 'success');
            } catch (error) {
                addResult('‚ùå Erro Query Complexa', error.message, 'error');
                updateStatus('‚ùå Query complexa falhou', 'error');
            }
        };

        // üìã Testar AIH Espec√≠fica
        window.testSpecificAIH = async () => {
            updateStatus('üîÑ Testando AIH espec√≠fica...', 'info');
            try {
                // Primeiro verificar se a AIH existe
                const { data: aihData, error: aihError } = await supabase
                    .from('aihs')
                    .select('id, aih_number, patient_id')
                    .eq('id', TARGET_AIH_ID)
                    .single();
                
                if (aihError) {
                    addResult('‚ö†Ô∏è AIH N√£o Encontrada', `AIH ${TARGET_AIH_ID} n√£o existe na tabela aihs`, 'warning');
                    updateStatus('‚ö†Ô∏è AIH n√£o encontrada', 'warning');
                    return;
                }
                
                addResult('‚úÖ AIH Encontrada', aihData, 'success');
                
                // Agora buscar procedimentos
                const { data: procData, error: procError } = await supabase
                    .from('procedure_records')
                    .select('*')
                    .eq('aih_id', TARGET_AIH_ID);
                
                if (procError) throw procError;
                
                addResult('üìã Procedimentos da AIH', `${procData?.length || 0} procedimentos encontrados`, procData?.length > 0 ? 'success' : 'warning');
                updateStatus('‚úÖ Teste da AIH conclu√≠do', 'success');
                
            } catch (error) {
                addResult('‚ùå Erro Teste AIH', error.message, 'error');
                updateStatus('‚ùå Teste da AIH falhou', 'error');
            }
        };

        // üß™ Criar Dados de Teste
        window.createTestData = async () => {
            updateStatus('üîÑ Criando dados de teste...', 'info');
            try {
                // Verificar se a AIH existe
                const { data: aihData } = await supabase
                    .from('aihs')
                    .select('id, patient_id')
                    .eq('id', TARGET_AIH_ID)
                    .single();
                
                if (!aihData) {
                    addResult('‚ö†Ô∏è Imposs√≠vel Criar Dados', 'AIH de destino n√£o existe', 'warning');
                    return;
                }

                const testProcedures = [
                    {
                        hospital_id: TARGET_HOSPITAL_ID,
                        aih_id: TARGET_AIH_ID,
                        patient_id: aihData.patient_id,
                        procedure_sequence: 1,
                        procedure_code: '0301010019',
                        procedure_description: 'Consulta m√©dica em aten√ß√£o prim√°ria',
                        match_status: 'pending',
                        match_confidence: 0.95,
                        value_charged: 2200,
                        professional: 'Dr. Jo√£o Silva - TESTE',
                        professional_cbo: '225125',
                        procedure_date: new Date().toISOString().split('T')[0],
                        created_by: 'test-system'
                    },
                    {
                        hospital_id: TARGET_HOSPITAL_ID,
                        aih_id: TARGET_AIH_ID,
                        patient_id: aihData.patient_id,
                        procedure_sequence: 2,
                        procedure_code: '0301010027',
                        procedure_description: 'Consulta m√©dica em aten√ß√£o especializada',
                        match_status: 'approved',
                        match_confidence: 0.89,
                        value_charged: 3500,
                        professional: 'Dr. Maria Santos - TESTE',
                        professional_cbo: '225130',
                        procedure_date: new Date().toISOString().split('T')[0],
                        created_by: 'test-system'
                    }
                ];

                const { data, error } = await supabase
                    .from('procedure_records')
                    .insert(testProcedures)
                    .select();
                
                if (error) throw error;
                
                addResult('üß™ Dados de Teste Criados', `${data?.length || 0} procedimentos de teste inseridos`, 'success');
                updateStatus('‚úÖ Dados de teste criados', 'success');
                
            } catch (error) {
                addResult('‚ùå Erro Criar Dados', error.message, 'error');
                updateStatus('‚ùå Falha ao criar dados', 'error');
            }
        };

        // üßπ Limpar Resultados
        window.clearResults = () => {
            document.getElementById('results').innerHTML = '';
            updateStatus('üßπ Resultados limpos', 'info');
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            addResult('üöÄ Sistema Iniciado', 'Ferramenta de teste carregada. Clique nos bot√µes para come√ßar os testes.', 'info');
        });
    </script>
</body>
</html> 