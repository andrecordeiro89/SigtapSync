<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Procedimentos por Paciente</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #2563eb;
            margin-top: 0;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .button {
            background: #2563eb;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        .button:hover {
            background: #1d4ed8;
        }
        .success {
            color: #16a34a;
            font-weight: bold;
        }
        .error {
            color: #dc2626;
            font-weight: bold;
        }
        .warning {
            color: #d97706;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü©∫ Teste de Procedimentos por Paciente</h1>
            <p>Valida√ß√£o dos dados reais do sistema SIGTAP-Sync</p>
        </div>

        <div class="test-section">
            <h3>üìã Teste 1: Valida√ß√£o de Dados Reais</h3>
            <p>Verificar se os dados est√£o sendo carregados corretamente da view doctor_production</p>
            <button class="button" onclick="testDataValidation()">Executar Teste</button>
            <div id="test1-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üîç Teste 2: An√°lise de M√©dico Espec√≠fico</h3>
            <p>Analisar um m√©dico espec√≠fico para verificar contagem de AIH vs Pacientes</p>
            <input type="text" id="doctor-identifier" placeholder="CNS ou CRM do m√©dico" style="padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
            <button class="button" onclick="testSpecificDoctor()">Analisar M√©dico</button>
            <div id="test2-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üìä Teste 3: Valida√ß√£o de Procedimentos Detalhados</h3>
            <p>Verificar se os procedimentos est√£o sendo detalhados corretamente</p>
            <button class="button" onclick="testDetailedProcedures()">Verificar Detalhes</button>
            <div id="test3-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üéØ Teste 4: Regra 1 AIH = 1 Paciente</h3>
            <p>Validar se a regra de neg√≥cio est√° sendo respeitada</p>
            <button class="button" onclick="testAIHPatientRule()">Validar Regra</button>
            <div id="test4-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üîß Instru√ß√µes de Uso</h3>
            <div class="result">
<strong>Como usar este teste:</strong>

1. Abra o Dashboard Executivo do SIGTAP-Sync
2. Abra o Console do navegador (F12 ‚Üí Console)
3. Volte para esta p√°gina
4. Execute os testes clicando nos bot√µes

<strong>Dados necess√°rios:</strong>
- CNS ou CRM de um m√©dico que tenha discrep√¢ncia (ex: 8 AIH vs 10 pacientes)
- Acesso ao sistema SIGTAP-Sync em outra aba

<strong>Logs esperados:</strong>
‚úÖ Dados reais sendo carregados
‚úÖ Separa√ß√£o correta por m√©dico
‚úÖ Contagem correta de pacientes √∫nicos
‚úÖ Procedimentos detalhados dispon√≠veis
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para testar se os dados est√£o sendo carregados
        async function testDataValidation() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.innerHTML = 'üîç Iniciando teste de valida√ß√£o de dados...\n';
            
            try {
                // Verificar se existe acesso ao sistema
                if (typeof window.MedicalProductionControlService === 'undefined') {
                    resultDiv.innerHTML += '‚ö†Ô∏è AVISO: MedicalProductionControlService n√£o encontrado.\n';
                    resultDiv.innerHTML += 'üìã INSTRU√á√ïES:\n';
                    resultDiv.innerHTML += '1. Abra o Dashboard Executivo do SIGTAP-Sync\n';
                    resultDiv.innerHTML += '2. Aguarde o carregamento completo\n';
                    resultDiv.innerHTML += '3. Execute este teste novamente\n';
                    return;
                }
                
                resultDiv.innerHTML += '‚úÖ Servi√ßo encontrado!\n';
                resultDiv.innerHTML += 'üìä Testando acesso aos dados...\n';
                
                // Teste b√°sico de conectividade
                const testResult = await window.MedicalProductionControlService.getDoctorProductionRecords('test', { limit: 1 });
                
                if (testResult.success) {
                    resultDiv.innerHTML += `‚úÖ Conex√£o com dados: OK\n`;
                    resultDiv.innerHTML += `üìã Dados dispon√≠veis: ${testResult.data.length > 0 ? 'SIM' : 'VAZIO'}\n`;
                } else {
                    resultDiv.innerHTML += `‚ùå Erro na conex√£o: ${testResult.error}\n`;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `‚ùå Erro no teste: ${error.message}\n`;
            }
        }

        // Fun√ß√£o para testar m√©dico espec√≠fico
        async function testSpecificDoctor() {
            const doctorId = document.getElementById('doctor-identifier').value;
            const resultDiv = document.getElementById('test2-result');
            
            if (!doctorId) {
                resultDiv.innerHTML = '‚ö†Ô∏è Por favor, insira o CNS ou CRM do m√©dico';
                return;
            }
            
            resultDiv.innerHTML = `üîç Analisando m√©dico: ${doctorId}\n`;
            
            try {
                if (typeof window.MedicalProductionControlService === 'undefined') {
                    resultDiv.innerHTML += '‚ùå Servi√ßo n√£o encontrado. Abra o Dashboard primeiro.\n';
                    return;
                }
                
                // Buscar dados brutos
                const rawResult = await window.MedicalProductionControlService.getDoctorProductionRecords(doctorId, { limit: 1000 });
                
                if (rawResult.success) {
                    const rawData = rawResult.data;
                    resultDiv.innerHTML += `üìã Registros brutos encontrados: ${rawData.length}\n`;
                    
                    // An√°lise de agrupamento
                    const patientsByCns = new Map();
                    const patientsByName = new Map();
                    
                    rawData.forEach(record => {
                        if (record.patient_cns) {
                            patientsByCns.set(record.patient_cns, (patientsByCns.get(record.patient_cns) || 0) + 1);
                        }
                        if (record.patient_name) {
                            patientsByName.set(record.patient_name, (patientsByName.get(record.patient_name) || 0) + 1);
                        }
                    });
                    
                    resultDiv.innerHTML += `üë• Pacientes √∫nicos por CNS: ${patientsByCns.size}\n`;
                    resultDiv.innerHTML += `üë• Pacientes √∫nicos por Nome: ${patientsByName.size}\n`;
                    
                    // Buscar dados processados
                    const processedResult = await window.MedicalProductionControlService.getDoctorPatientsAndProcedures(doctorId, { limit: 50 });
                    
                    if (processedResult.success) {
                        resultDiv.innerHTML += `‚úÖ Pacientes processados: ${processedResult.data.length}\n`;
                        
                        // Verificar integridade
                        const totalProcedures = processedResult.data.reduce((sum, p) => sum + p.total_procedures_together, 0);
                        resultDiv.innerHTML += `üìä Total de procedimentos agrupados: ${totalProcedures}\n`;
                        
                        if (totalProcedures === rawData.length) {
                            resultDiv.innerHTML += '‚úÖ INTEGRIDADE OK: Procedimentos = Registros\n';
                        } else {
                            resultDiv.innerHTML += `‚ö†Ô∏è POSS√çVEL PROBLEMA: ${totalProcedures} ‚â† ${rawData.length}\n`;
                        }
                    } else {
                        resultDiv.innerHTML += `‚ùå Erro nos dados processados: ${processedResult.error}\n`;
                    }
                } else {
                    resultDiv.innerHTML += `‚ùå Erro nos dados brutos: ${rawResult.error}\n`;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `‚ùå Erro no teste: ${error.message}\n`;
            }
        }

        // Fun√ß√£o para testar procedimentos detalhados
        async function testDetailedProcedures() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.innerHTML = 'üîç Verificando procedimentos detalhados...\n';
            
            try {
                if (typeof window.MedicalProductionControlService === 'undefined') {
                    resultDiv.innerHTML += '‚ùå Servi√ßo n√£o encontrado. Abra o Dashboard primeiro.\n';
                    return;
                }
                
                // Buscar dados de um m√©dico qualquer
                const rawResult = await window.MedicalProductionControlService.getDoctorProductionRecords('test', { limit: 10 });
                
                if (rawResult.success && rawResult.data.length > 0) {
                    const sample = rawResult.data[0];
                    resultDiv.innerHTML += '‚úÖ Dados encontrados\n';
                    resultDiv.innerHTML += `üìã Campos dispon√≠veis: ${Object.keys(sample).join(', ')}\n`;
                    
                    // Verificar campos essenciais
                    const requiredFields = ['procedure_code', 'procedure_name', 'value_charged', 'total_value', 'quantity'];
                    const missingFields = requiredFields.filter(field => !sample.hasOwnProperty(field));
                    
                    if (missingFields.length === 0) {
                        resultDiv.innerHTML += '‚úÖ Todos os campos necess√°rios est√£o presentes\n';
                    } else {
                        resultDiv.innerHTML += `‚ö†Ô∏è Campos ausentes: ${missingFields.join(', ')}\n`;
                    }
                    
                    // Amostra de dados
                    resultDiv.innerHTML += '\nüìä AMOSTRA DE DADOS:\n';
                    resultDiv.innerHTML += `Procedimento: ${sample.procedure_name}\n`;
                    resultDiv.innerHTML += `C√≥digo: ${sample.procedure_code}\n`;
                    resultDiv.innerHTML += `Valor: R$ ${(sample.total_value / 100).toFixed(2)}\n`;
                    resultDiv.innerHTML += `Quantidade: ${sample.quantity}\n`;
                    
                } else {
                    resultDiv.innerHTML += '‚ùå Nenhum dado encontrado\n';
                }
                
            } catch (error) {
                resultDiv.innerHTML += `‚ùå Erro no teste: ${error.message}\n`;
            }
        }

        // Fun√ß√£o para testar regra AIH = Paciente
        async function testAIHPatientRule() {
            const resultDiv = document.getElementById('test4-result');
            resultDiv.innerHTML = 'üéØ Testando regra 1 AIH = 1 Paciente...\n';
            
            try {
                if (typeof window.MedicalProductionControlService === 'undefined') {
                    resultDiv.innerHTML += '‚ùå Servi√ßo n√£o encontrado. Abra o Dashboard primeiro.\n';
                    return;
                }
                
                resultDiv.innerHTML += 'üìã Esta regra √© conceitual e deve ser validada manualmente:\n';
                resultDiv.innerHTML += '\nüîç COMO VALIDAR:\n';
                resultDiv.innerHTML += '1. Cada AIH corresponde a um paciente espec√≠fico\n';
                resultDiv.innerHTML += '2. Um paciente pode ter m√∫ltiplos procedimentos na mesma AIH\n';
                resultDiv.innerHTML += '3. Mas n√£o pode ter m√∫ltiplas AIHs ativas simultaneamente\n';
                resultDiv.innerHTML += '\n‚úÖ VERIFICA√á√ÉO:\n';
                resultDiv.innerHTML += '- Se m√©dico tem 8 AIH, deve ter 8 pacientes √∫nicos\n';
                resultDiv.innerHTML += '- Se mostra 10 pacientes, h√° duplica√ß√£o ou erro de agrupamento\n';
                resultDiv.innerHTML += '\nüîß CORRE√á√ÉO APLICADA:\n';
                resultDiv.innerHTML += '- Agrupamento por CNS priorit√°rio\n';
                resultDiv.innerHTML += '- Fallback para Nome + Data nascimento\n';
                resultDiv.innerHTML += '- Valida√ß√£o de integridade nos logs\n';
                
            } catch (error) {
                resultDiv.innerHTML += `‚ùå Erro no teste: ${error.message}\n`;
            }
        }

        // Carregar automaticamente ao abrir a p√°gina
        window.onload = function() {
            console.log('ü©∫ P√°gina de teste carregada');
            console.log('üí° Use os bot√µes para executar os testes');
        };
    </script>
</body>
</html> 